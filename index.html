<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>Image Checker 圖片檢查工具</title>
<style>
body { margin:0; font-family: Arial, sans-serif; background:#111; color:#eee; }
#dropZone { position:fixed; left:0; top:0; right:0; bottom:0; border:2px dashed #555; display:flex; align-items:center; justify-content:center; text-align:center; }
#controls { position:fixed; top:12px; left:12px; }
button { margin:4px; }
.series { border:1px solid #444; margin:8px; padding:8px; }
.cell { width:120px; height:120px; border:1px solid #555; display:inline-block; position:relative; margin:4px; overflow:hidden; }
.cell img { width:100%; height:100%; object-fit:cover; position:absolute; left:0; top:0; cursor:pointer; }
.missing { color:#f55; font-size:12px; }

#viewerOverlay { position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.85); display:none; z-index:10000; }
#viewerContainer { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); cursor:grab; }
#viewerContainer img { display:block; }
#viewerClose { position:fixed; right:16px; top:16px; font-size:24px; cursor:pointer; }
#viewerScaleLabel { position:fixed; left:16px; top:16px; }

.viewer-arrow { position: fixed; top: 50%; transform: translateY(-50%); font-size: 48px; color: rgba(255,255,255,0.7); cursor: pointer; user-select: none; z-index: 10001; padding: 12px; }
.viewer-arrow:hover { color: rgba(255,255,255,1); }
#viewerPrev { left: 12px; }
#viewerNext { right: 12px; }

#viewerInfo { position: fixed; bottom: 25%; right: 16px; color: rgba(255,255,255,0.75); font-size: 14px; line-height: 1.4; text-align: right; z-index: 10001; }
#viewerInfo .small-en { font-size:0.85em; }
</style>
</head>
<body>
<div id="controls">
  <button id="openImages">選取圖片<br><span class="small-en">Select Images</span></button>
  <button id="openFolder">選取資料夾<br><span class="small-en">Select Folder</span></button>
</div>
<div id="dropZone">拖入圖片或資料夾<br><span class="small-en">Drop images or folders here</span></div>
<div id="output"></div>

<div id="viewerOverlay">
  <div id="viewerContainer"></div>
  <div id="viewerPrev" class="viewer-arrow">‹</div>
  <div id="viewerNext" class="viewer-arrow">›</div>
  <div id="viewerClose">✕</div>
  <div id="viewerScaleLabel">30%</div>
  <div id="viewerInfo">
    滾輪：縮放　拖曳：平移<br>
    + / -：縮放　← / →：切換疊合序列　Esc：關閉
    <div class="small-en">
      Wheel: Zoom &nbsp; Drag: Pan<br>
      + / -: Zoom &nbsp; ← / →: Overlay Sequence &nbsp; Esc: Close
    </div>
  </div>
</div>

<input type="file" id="fileInput" multiple accept="image/*" style="display:none" />
<input type="file" id="folderInput" webkitdirectory directory style="display:none" />

<script>
const output = document.getElementById("output");
const dropZone = document.getElementById("dropZone");
const fileInput = document.getElementById("fileInput");
const folderInput = document.getElementById("folderInput");

const viewerOverlay = document.getElementById("viewerOverlay");
const viewerContainer = document.getElementById("viewerContainer");
const viewerClose = document.getElementById("viewerClose");
const viewerScaleLabel = document.getElementById("viewerScaleLabel");
const viewerPrev = document.getElementById("viewerPrev");
const viewerNext = document.getElementById("viewerNext");

let seriesMap = {};

let viewerSeries = null;
let viewerIndex = 0;
let viewerScale = 0.3;
let isDragging = false;
let dragStart = {x:0,y:0};
let imgStart = {x:0,y:0};

// ===== Helpers =====
function parseName(name) {
  const m = name.match(/(.+?)[-_ ]?(g[1-6])/i);
  if (!m) return null;
  return { series: m[1], g: m[2].toLowerCase() };
}

function isValidSize(file, cb) {
  const img = new Image();
  img.onload = () => cb(img.width === 4800 && img.height === 4800);
  img.src = URL.createObjectURL(file);
}

function handleFiles(files) {
  [...files].forEach(file => {
    const info = parseName(file.name);
    if (!info) return;

    isValidSize(file, ok => {
      if (!ok) return;
      if (!seriesMap[info.series]) seriesMap[info.series] = { A:{}, B:{} };
      const format = file.name.includes("A") ? "A" : "B";
      if (!seriesMap[info.series][format][info.g]) seriesMap[info.series][format][info.g] = [];
      seriesMap[info.series][format][info.g].push(file);
      render();
    });
  });
}

// ===== Rendering =====
function render() {
  output.innerHTML = "";
  Object.keys(seriesMap).forEach(series => {
    const div = document.createElement("div");
    div.className = "series";
    div.innerHTML = `<h3>${series}</h3>`;

    for (let i=1;i<=6;i++){
      const g = "g"+i;
      const cell = document.createElement("div");
      cell.className = "cell";

      const aImgs = seriesMap[series].A[g]||[];
      const bImgs = seriesMap[series].B[g]||[];

      if (aImgs.length||bImgs.length) {
        [...aImgs,...bImgs].forEach((file,idx)=>{
          const img = document.createElement("img");
          img.src = URL.createObjectURL(file);
          img.style.opacity = idx===0?1:0.5;
          img.addEventListener("click",()=>openOverlaySequence(series,i));
          cell.appendChild(img);
        });
      } else {
        cell.innerHTML = `<div class="missing">缺少 ${g}<br><span class="small-en">Lack of ${g}</span></div>`;
      }
      div.appendChild(cell);
    }
    output.appendChild(div);
  });
}

// ===== Overlay Sequence Logic =====
function openOverlaySequence(series, gIndex) {
  viewerSeries = series;
  viewerIndex = gIndex - 1;
  viewerScale = 0.3;
  updateViewerImage();
  viewerOverlay.style.display = "block";
}

function updateViewerImage() {
  viewerContainer.innerHTML = "";
  const g = "g"+(viewerIndex+1);
  const aImgs = seriesMap[viewerSeries].A[g]||[];
  const bImgs = seriesMap[viewerSeries].B[g]||[];

  [...aImgs,...bImgs].forEach((file,idx)=>{
    const img = document.createElement("img");
    img.src = URL.createObjectURL(file);
    img.style.position = "absolute";
    img.style.left = "0";
    img.style.top = "0";
    img.style.opacity = idx===0?1:0.5;
    viewerContainer.appendChild(img);
  });

  viewerContainer.style.left = "50%";
  viewerContainer.style.top = "50%";
  viewerContainer.style.transform = `translate(-50%,-50%) scale(${viewerScale})`;
  viewerScaleLabel.textContent = Math.round(viewerScale*100)+"%";
}

function prevImage() {
  if (!viewerSeries) return;
  viewerIndex = (viewerIndex + 5) % 6;
  updateViewerImage();
}

function nextImage() {
  if (!viewerSeries) return;
  viewerIndex = (viewerIndex + 1) % 6;
  updateViewerImage();
}

// ===== Viewer Interaction =====
viewerPrev.onclick = e => { e.stopPropagation(); prevImage(); };
viewerNext.onclick = e => { e.stopPropagation(); nextImage(); };
viewerClose.onclick = ()=> viewerOverlay.style.display="none";

viewerOverlay.addEventListener("wheel", e=>{
  e.preventDefault();
  viewerScale += e.deltaY<0?0.05:-0.05;
  viewerScale = Math.max(0.05,Math.min(3,viewerScale));
  updateViewerImage();
});

viewerContainer.addEventListener("mousedown", e=>{
  isDragging = true;
  dragStart = {x:e.clientX,y:e.clientY};
  const rect = viewerContainer.getBoundingClientRect();
  imgStart = {x:rect.left,y:rect.top};
});

window.addEventListener("mousemove", e=>{
  if (!isDragging) return;
  viewerContainer.style.left = imgStart.x + (e.clientX-dragStart.x) + "px";
  viewerContainer.style.top = imgStart.y + (e.clientY-dragStart.y) + "px";
  viewerContainer.style.transform = `scale(${viewerScale})`;
});

window.addEventListener("mouseup", ()=> isDragging=false);

window.addEventListener("keydown", e=>{
  if (viewerOverlay.style.display!=="block") return;
  if (e.key==="Escape") viewerOverlay.style.display="none";
  if (e.key==="ArrowLeft") prevImage();
  if (e.key==="ArrowRight") nextImage();
  if (e.key==="+") { viewerScale+=0.05; updateViewerImage(); }
  if (e.key==="-") { viewerScale-=0.05; updateViewerImage(); }
});

// ===== Input Handling =====
dropZone.ondragover = e=>{e.preventDefault();};
dropZone.ondrop = e=>{e.preventDefault(); handleFiles(e.dataTransfer.files);};
fileInput.onchange = e=> handleFiles(e.target.files);
folderInput.onchange = e=> handleFiles(e.target.files);

document.getElementById("openImages").onclick = ()=> fileInput.click();
document.getElementById("openFolder").onclick = ()=> folderInput.click();
</script>
</body>
</html>
