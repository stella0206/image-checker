<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>åœ–ç‰‡æª¢æŸ¥å·¥å…·</title>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 20px;
}

h1, h2, h3 {
  margin-top: 24px;
}

/* ===== æ‹–æ›³å€ ===== */
#dropZone {
  border: 3px dashed #444;
  padding: 40px;
  text-align: center;
  font-size: 18px;
  margin-bottom: 20px;
}

#dropZone.dragover {
  background: #f0f0f0;
}

/* ===== å€å¡Š ===== */
.section {
  margin-bottom: 48px;
  padding-bottom: 16px;
  border-bottom: 1px dashed #ccc;
}

/* ===== Grid ===== */
.grid-6 {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 16px;
}

.image-card {
  border: 1px solid #ddd;
  padding: 8px;
  font-size: 12px;
  border-radius: 6px;
  background: #fafafa;
}

.image-card b {
  display: block;
  margin-bottom: 4px;
  text-align: center;
}

.overlay-box {
  position: relative;
  width: 100%;
  aspect-ratio: 1 / 1;
  border: 1px solid #aaa;
  background: #fdfdfd;
  border-radius: 4px;
}

/* åœ–ç‰‡ä¸èƒ½åƒæ‰æ‹–æ›³äº‹ä»¶ */
.overlay-box img {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
  pointer-events: none;
}

.ok { color: green; }
.error { color: red; }

/* ===== debug ===== */
#debug {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #111;
  color: #0f0;
  font-size: 12px;
  padding: 4px 8px;
  z-index: 9999;
  white-space: pre;
}
</style>
</head>

<body>

<h1>åœ–ç‰‡æª¢æŸ¥å·¥å…·</h1>

<div id="dropZone">
  ğŸ‘‰ æ‹–å…¥åœ–ç‰‡ / å¤šå€‹è³‡æ–™å¤¾ / æ··åˆçš†å¯ï¼ˆChromeï¼‰
</div>

<h2>ç³»åˆ—å®Œæ•´æ€§æª¢æŸ¥</h2>
<div id="seriesCheck"></div>

<h2>ç–Šåˆæª¢æŸ¥</h2>
<div id="overlayArea"></div>

<div id="debug"></div>

<script>
/* =========================================================
   å…¨åŸŸé˜²å‘†ï¼ˆä¸€å®šè¦ï¼Œä½† dropZone ä¹Ÿè¦å† prevent ä¸€æ¬¡ï¼‰
========================================================= */
document.addEventListener("dragover", e => e.preventDefault());
document.addEventListener("drop", e => e.preventDefault());

/* =========================================================
   è¦å‰‡
========================================================= */
const formatARegex = /^3([MW])G(\d{8})-ka-(g[1-6])$/;
const formatBRegex = /^(g[12456])$/;
const GRID_G = ["g1","g2","g4","g5","g6"];
const REQUIRED_G = ["g1","g2","g3","g4","g5","g6"];

let images = [];

/* =========================================================
   æ‹–æ›³è³‡æ–™å¤¾éè¿´è®€å–
========================================================= */
function readEntry(entry) {
  return new Promise(resolve => {
    if (entry.isFile) {
      entry.file(f => resolve([f]));
    } else {
      const reader = entry.createReader();
      reader.readEntries(entries => {
        Promise.all(entries.map(readEntry))
          .then(r => resolve(r.flat()));
      });
    }
  });
}

/* =========================================================
   Drop è™•ç†
========================================================= */
async function handleDrop(e) {
  const dbg = document.getElementById("debug");
  const dt = e.dataTransfer;

  dbg.textContent =
    `items: ${dt.items ? dt.items.length : 0}\n` +
    `files: ${dt.files ? dt.files.length : 0}`;

  if (dt.items && dt.items.length) {
    const entries = [...dt.items]
      .map(i => i.webkitGetAsEntry && i.webkitGetAsEntry())
      .filter(Boolean);

    if (entries.length) {
      const files = (await Promise.all(entries.map(readEntry))).flat();
      dbg.textContent += `\nentries files: ${files.length}`;
      files.forEach(processFile);
      return;
    }
  }

  if (dt.files && dt.files.length) {
    dbg.textContent += `\nfallback files`;
    [...dt.files].forEach(processFile);
  }
}

/* =========================================================
   è™•ç†åœ–ç‰‡
========================================================= */
function processFile(file) {
  if (!file.type.startsWith("image/")) return;

  const name = file.name.replace(/\.[^/.]+$/, "");
  let format = "INVALID";
  let g = null;
  let seriesKey = null;

  let m = name.match(formatARegex);
  if (m) {
    format = "A";
    seriesKey = `3${m[1]}G${m[2]}`;
    g = m[3];
  } else if (formatBRegex.test(name)) {
    format = "B";
    g = name;
  }

  const url = URL.createObjectURL(file);
  images.push({ name, format, g, seriesKey, url });
  render();
}

/* =========================================================
   Render
========================================================= */
function render() {
  overlayArea.innerHTML = "";
  seriesCheck.innerHTML = "";

  const seriesMap = {};
  images.filter(i => i.format === "A").forEach(i => {
    if (!seriesMap[i.seriesKey]) seriesMap[i.seriesKey] = [];
    seriesMap[i.seriesKey].push(i);
  });

  Object.entries(seriesMap).forEach(([key, list]) => {
    const found = list.map(i => i.g);
    const missing = REQUIRED_G.filter(g => !found.includes(g));
    const div = document.createElement("div");
    div.innerHTML =
      `<b>${key}</b>ï¼š` +
      (missing.length
        ? `<span class="error">ç¼ºå°‘ ${missing.join(", ")}</span>`
        : `<span class="ok">âœ” å®Œæ•´</span>`);
    seriesCheck.appendChild(div);
  });

  Object.entries(seriesMap).forEach(([key, list]) => {
    const section = document.createElement("div");
    section.className = "section";
    section.innerHTML = `<h3>${key}</h3><div class="grid-6"></div>`;
    const grid = section.querySelector(".grid-6");

    GRID_G.forEach(g => {
      const card = document.createElement("div");
      card.className = "image-card";
      card.innerHTML = `<b>${g}</b><div class="overlay-box"></div>`;
      const box = card.querySelector(".overlay-box");

      const b = images.find(i => i.format === "B" && i.g === g);
      if (b) box.innerHTML += `<img src="${b.url}">`;

      list.filter(i => i.g === g).forEach(i => {
        box.innerHTML += `<img src="${i.url}">`;
      });

      grid.appendChild(card);
    });

    overlayArea.appendChild(section);
  });

  /* g3ï¼šèˆ‡ä¸Šé¢å°ºå¯¸å®Œå…¨ä¸€è‡´ */
  const allG3 = images.filter(i => i.format === "A" && i.g === "g3");
  if (allG3.length) {
    const section = document.createElement("div");
    section.className = "section";
    section.innerHTML =
      `<h2>g3ï¼ˆæ ¼å¼ Aãƒ»å…¨ç³»åˆ—ç–Šåˆæª¢æŸ¥ï¼‰</h2>
       <div class="grid-6">
         <div class="image-card">
           <b>g3</b>
           <div class="overlay-box"></div>
         </div>
       </div>`;

    const box = section.querySelector(".overlay-box");
    allG3.forEach(i => box.innerHTML += `<img src="${i.url}">`);

    overlayArea.appendChild(section);
  }
}

/* =========================================================
   Drop Zone ç¶å®šï¼ˆâš  é€™è£¡ä¸€å®šè¦ preventDefaultï¼‰
========================================================= */
const dropZone = document.getElementById("dropZone");

dropZone.addEventListener("dragover", e => {
  e.preventDefault();
  dropZone.classList.add("dragover");
});

dropZone.addEventListener("dragleave", () => {
  dropZone.classList.remove("dragover");
});

dropZone.addEventListener("drop", e => {
  e.preventDefault();          // â† é—œéµä¿®æ­£
  dropZone.classList.remove("dragover");
  handleDrop(e);
});
</script>

</body>
</html>
