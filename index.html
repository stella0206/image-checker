<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>åœ–ç‰‡æª¢æŸ¥å·¥å…· Image Inspection Tool</title>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 20px;
}

h1, h2, h3 {
  margin-top: 24px;
  line-height: 1.25;
}

.small-en {
  display: block;
  font-size: 0.75em;
  color: #555;
}

#dropZone {
  border: 3px dashed #444;
  padding: 36px;
  text-align: center;
  font-size: 18px;
  margin-bottom: 16px;
  cursor: pointer;
}

#dropZone.dragover {
  background: #f0f0f0;
}

.controls {
  margin-bottom: 20px;
}

.controls button {
  margin-right: 8px;
}

.section {
  margin-bottom: 48px;
  padding-bottom: 16px;
  border-bottom: 1px dashed #ccc;
}

.grid-6 {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 16px;
}

.image-card {
  border: 1px solid #ddd;
  padding: 8px;
  font-size: 12px;
  border-radius: 6px;
  background: #fafafa;
}

.image-card b {
  display: block;
  margin-bottom: 4px;
  text-align: center;
}

.overlay-box {
  position: relative;
  width: 100%;
  aspect-ratio: 1 / 1;
  border: 1px solid #aaa;
  background: #fdfdfd;
  border-radius: 4px;
}

.overlay-box img {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
  cursor: pointer;
}

.ok { color: green; }
.error { color: red; }

/* ===== Viewer ===== */
#viewerOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.88);
  display: none;
  z-index: 10000;
}

#viewerContainer {
  position: absolute;
  inset: 0;
  overflow: hidden;
}

#viewerWrap {
  position: absolute;
  top: 50%;
  left: 50%;
  transform-origin: center;
}

#viewerWrap img {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
  pointer-events: none;
}

#viewerClose {
  position: fixed;
  top: 12px;
  right: 16px;
  font-size: 22px;
  color: #fff;
  cursor: pointer;
  z-index: 10001;
}

#viewerScale {
  position: fixed;
  top: 12px;
  left: 16px;
  color: #fff;
  font-size: 16px;
}

#viewerInfo {
  position: fixed;
  right: 16px;
  bottom: 25%;
  font-size: 14px;
  color: rgba(255,255,255,0.8);
  text-align: right;
}
</style>
</head>

<body>

<h1>
  åœ–ç‰‡æª¢æŸ¥å·¥å…·
  <span class="small-en">Image Inspection Tool</span>
</h1>

<div id="dropZone">
  ğŸ‘‰ æ‹–å…¥åœ–ç‰‡æˆ–è³‡æ–™å¤¾ï¼Œæˆ–é»æ­¤é¸å–
  <span class="small-en">Drag images or folders here, or click to browse</span>
</div>

<div class="controls">
  <button id="openFilesBtn">é¸å–åœ–ç‰‡<span class="small-en">Select Images</span></button>
  <button id="openFolderBtn">é¸å–è³‡æ–™å¤¾<span class="small-en">Select Folder</span></button>
  <input id="fileInput" type="file" multiple accept="image/*" hidden>
  <input id="folderInput" type="file" webkitdirectory hidden>
</div>

<h2>ç³»åˆ—å®Œæ•´æ€§æª¢æŸ¥<span class="small-en">Series Completeness Check</span></h2>
<div id="seriesCheck"></div>

<h2>ç–Šåˆæª¢æŸ¥<span class="small-en">Overlay Inspection</span></h2>
<div id="overlayArea"></div>

<div id="viewerOverlay">
  <div id="viewerContainer"></div>
  <div id="viewerClose">âœ•</div>
  <div id="viewerScale">30%</div>
  <div id="viewerInfo">
    â† / â†’ï¼šåˆ‡æ› g<br>
    æ»¾è¼ªï¼šç¸®æ”¾ã€€æ‹–æ›³ï¼šå¹³ç§»<br>
    Escï¼šé—œé–‰
    <div class="small-en">
      â† / â†’: switch g<br>
      Wheel: zoom Â· Drag: pan<br>
      Esc: close
    </div>
  </div>
</div>

<script>
const REQUIRED_W = 4800;
const REQUIRED_H = 4800;

const formatARegex = /^3([MW])[A-Za-z](\d{8})-ka-(g[1-6])$/i;
const formatBRegex = /^(g[1-6])$/i;
const GS = ["g1","g2","g3","g4","g5","g6"];

let images = [];
let viewerSeries = null;
let viewerGIndex = 0;
let scale = 0.3, posX = 0, posY = 0;

/* ===== Drag & Select ===== */
function handleFiles(files) {
  [...files].forEach(file => {
    if (!file.type.startsWith("image/")) return;

    const url = URL.createObjectURL(file);
    const img = new Image();
    img.onload = () => {
      if (img.width !== REQUIRED_W || img.height !== REQUIRED_H) return;

      const name = file.name.replace(/\.[^/.]+$/, "");
      let format=null,g=null,key=null;

      let m = name.match(formatARegex);
      if (m) {
        format="A"; g=m[3].toLowerCase(); key=name.replace(/-ka-g[1-6]$/i,"");
      } else if (formatBRegex.test(name)) {
        format="B"; g=name.toLowerCase();
      }

      images.push({name,format,g,key,url});
      render();
    };
    img.src = url;
  });
}

dropZone.ondragover = e => { e.preventDefault(); dropZone.classList.add("dragover"); };
dropZone.ondragleave = () => dropZone.classList.remove("dragover");
dropZone.ondrop = e => {
  e.preventDefault();
  dropZone.classList.remove("dragover");
  handleFiles(e.dataTransfer.files);
};
dropZone.onclick = () => fileInput.click();

openFilesBtn.onclick = () => fileInput.click();
openFolderBtn.onclick = () => folderInput.click();
fileInput.onchange = e => handleFiles(e.target.files);
folderInput.onchange = e => handleFiles(e.target.files);

/* ===== Render ===== */
function render() {
  overlayArea.innerHTML = "";
  seriesCheck.innerHTML = "";

  const map = {};
  images.filter(i=>i.format==="A").forEach(i=>{
    if(!map[i.key]) map[i.key]=[];
    map[i.key].push(i);
  });

  Object.entries(map).forEach(([k,list])=>{
    const found=list.map(i=>i.g);
    const miss=GS.filter(g=>!found.includes(g));
    const d=document.createElement("div");
    d.innerHTML=`<b>${k}</b>ï¼š`+
      (miss.length?`<span class=error>ç¼ºå°‘ ${miss.join(", ")} (lack)</span>`
                  :`<span class=ok>âœ” å®Œæ•´ (complete)</span>`);
    seriesCheck.appendChild(d);
  });

  Object.entries(map).forEach(([k,list])=>{
    const sec=document.createElement("div");
    sec.className="section";
    sec.innerHTML=`<h3>${k}</h3><div class="grid-6"></div>`;
    const grid=sec.querySelector(".grid-6");

    GS.forEach(g=>{
      const card=document.createElement("div");
      card.className="image-card";
      card.innerHTML=`<b>${g}</b><div class="overlay-box"></div>`;
      const box=card.querySelector(".overlay-box");

      const b=images.find(i=>i.format==="B"&&i.g===g);
      if(b){
        const im=document.createElement("img");
        im.src=b.url;
        box.appendChild(im);
      }

      list.filter(i=>i.g===g).forEach(a=>{
        const im=document.createElement("img");
        im.src=a.url;
        im.onclick=()=>openViewer(k,g);
        box.appendChild(im);
      });

      grid.appendChild(card);
    });
    overlayArea.appendChild(sec);
  });
}

/* ===== Viewer ===== */
const overlay=document.getElementById("viewerOverlay");
const container=document.getElementById("viewerContainer");
const scaleLabel=document.getElementById("viewerScale");

function openViewer(series,g){
  viewerSeries=series;
  viewerGIndex=GS.indexOf(g);
  scale=0.3; posX=0; posY=0;
  overlay.style.display="block";
  renderViewer();
}

function renderViewer(){
  container.innerHTML="";
  const wrap=document.createElement("div");
  wrap.id="viewerWrap";
  wrap.style.transform=`translate(-50%,-50%) translate(${posX}px,${posY}px) scale(${scale})`;

  const g=GS[viewerGIndex];
  const b=images.find(i=>i.format==="B"&&i.g===g);
  const a=images.find(i=>i.format==="A"&&i.key===viewerSeries&&i.g===g);

  [b,a].forEach(i=>{
    if(!i) return;
    const im=document.createElement("img");
    im.src=i.url;
    wrap.appendChild(im);
  });

  container.appendChild(wrap);
  scaleLabel.textContent=Math.round(scale*100)+"%";
}

viewerOverlay.onwheel=e=>{
  e.preventDefault();
  scale+=e.deltaY<0?0.05:-0.05;
  scale=Math.max(0.2,Math.min(5,scale));
  renderViewer();
};

window.onkeydown=e=>{
  if(overlay.style.display!=="block") return;
  if(e.key==="Escape") overlay.style.display="none";
  if(e.key==="ArrowRight"){ viewerGIndex=(viewerGIndex+1)%6; renderViewer(); }
  if(e.key==="ArrowLeft"){ viewerGIndex=(viewerGIndex+5)%6; renderViewer(); }
};

viewerClose.onclick=()=>overlay.style.display="none";
overlay.onclick=e=>{ if(e.target===overlay) overlay.style.display="none"; };
</script>

</body>
</html>
