<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>åœ–ç‰‡æª¢æŸ¥å·¥å…· Image Inspection Tool</title>

<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
h1, h2, h3 { margin-top: 24px; line-height: 1.25; }
.small-en { display: block; font-size: 0.75em; color: #555; }
#dropZone { border: 3px dashed #444; padding: 36px; text-align: center; font-size: 18px; margin-bottom: 16px; cursor: pointer; }
#dropZone.dragover { background: #f0f0f0; }
.controls { margin-bottom: 20px; }
.controls button { margin-right: 8px; }
.section { margin-bottom: 48px; padding-bottom: 16px; border-bottom: 1px dashed #ccc; }
.grid-6 { display: grid; grid-template-columns: repeat(6, 1fr); gap: 16px; }
.image-card { border: 1px solid #ddd; padding: 8px; font-size: 12px; border-radius: 6px; background: #fafafa; }
.image-card b { display: block; margin-bottom: 4px; text-align: center; }
.overlay-box { position: relative; width: 100%; aspect-ratio: 1 / 1; border: 1px solid #aaa; background: #fdfdfd; border-radius: 4px; }
.overlay-box img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; cursor: pointer; }
.ok { color: green; }
.error { color: red; }

/* ===== Viewer ===== */
#viewerOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.88); display: none; z-index: 10000; }
#viewerContainer { position: absolute; inset: 0; overflow: hidden; cursor: grab; }
#viewerContainer:active { cursor: grabbing; }
#viewerImage { position: absolute; top: 50%; left: 50%; transform-origin: center center; user-select: none; pointer-events: none; }
#viewerClose { position: fixed; top: 12px; right: 16px; font-size: 22px; color: #fff; cursor: pointer; opacity: 0.85; z-index: 10001; }
#viewerClose:hover { opacity: 1; }
#viewerScaleLabel { position: fixed; top: 12px; left: 16px; color: #fff; font-size: 14px; opacity: 0.9; z-index: 10001; }
#viewerInfo { position: fixed; bottom: 25%; right: 16px; color: rgba(255,255,255,0.75); font-size: 14px; line-height: 1.4; text-align: right; z-index: 10001; }
#viewerInfo .small-en { font-size: 0.85em; }

/* ===== Viewer arrows ===== */
.viewer-arrow { position: fixed; top: 50%; transform: translateY(-50%); font-size: 48px; color: rgba(255,255,255,0.7); cursor: pointer; user-select: none; z-index: 10001; padding: 12px; }
.viewer-arrow:hover { color: rgba(255,255,255,1); }
#viewerPrev { left: 12px; }
#viewerNext { right: 12px; }
</style>
</head>
<body>

<h1>åœ–ç‰‡æª¢æŸ¥å·¥å…·<span class="small-en">Image Inspection Tool</span></h1>

<div id="dropZone">ğŸ‘‰ æ‹–å…¥åœ–ç‰‡ / è³‡æ–™å¤¾ï¼Œæˆ–é»æ­¤é¸å–<span class="small-en">Drag images / folders here, or click to browse</span></div>

<div class="controls">
  <button id="openFilesBtn">é¸å–åœ–ç‰‡<span class="small-en">Select Images</span></button>
  <button id="openFolderBtn">é¸å–è³‡æ–™å¤¾<span class="small-en">Select Folder</span></button>
  <input id="fileInput" type="file" multiple accept="image/*" hidden>
  <input id="folderInput" type="file" webkitdirectory hidden>
</div>

<h2>ç³»åˆ—å®Œæ•´æ€§æª¢æŸ¥<span class="small-en">Series Completeness Check</span></h2>
<div id="seriesCheck"></div>

<h2>ç–Šåˆæª¢æŸ¥<span class="small-en">Overlay Inspection</span></h2>
<div id="overlayArea"></div>

<div id="viewerOverlay">
  <div id="viewerContainer"></div>
  <div id="viewerPrev" class="viewer-arrow">â€¹</div>
  <div id="viewerNext" class="viewer-arrow">â€º</div>
  <div id="viewerClose">âœ•</div>
  <div id="viewerScaleLabel">30%</div>
  <div id="viewerInfo">
    æ»¾è¼ªï¼šç¸®æ”¾ã€€æ‹–æ›³ï¼šå¹³ç§»<br>
    + / -ï¼šç¸®æ”¾ã€€â† / â†’ï¼šåˆ‡æ›åœ–ç‰‡ã€€Escï¼šé—œé–‰
    <div class="small-en">Wheel: Zoom &nbsp; Drag: Pan<br>+ / -: Zoom &nbsp; â† / â†’: Previous / Next &nbsp; Esc: Close</div>
  </div>
</div>

<script>
const REQUIRED_WIDTH = 4800;
const REQUIRED_HEIGHT = 4800;

const formatARegex = /^3([MW])[A-Za-z](\d{8})-ka-(g[1-6])$/i;
const formatBRegex = /^(g[12456])$/i;
const GRID_G = ["g1","g2","g4","g5","g6"];
const REQUIRED_G = ["g1","g2","g3","g4","g5","g6"];

let images = [];
let viewerList = [];
let viewerIndex = 0;

function readEntry(entry) {
  return new Promise(resolve => {
    if (entry.isFile) entry.file(f => resolve([f]));
    else {
      const reader = entry.createReader();
      reader.readEntries(entries => Promise.all(entries.map(readEntry)).then(r => resolve(r.flat())));
    }
  });
}

async function handleDrop(e) {
  const dt = e.dataTransfer;
  if (dt.items && dt.items.length) {
    const entries = [...dt.items].map(i => i.webkitGetAsEntry && i.webkitGetAsEntry()).filter(Boolean);
    if (entries.length) (await Promise.all(entries.map(readEntry))).flat().forEach(processFile);
    return;
  }
  if (dt.files && dt.files.length) [...dt.files].forEach(processFile);
}

function processFile(file) {
  if (!file.type.startsWith("image/")) return;
  const url = URL.createObjectURL(file);
  const img = new Image();

  img.onload = () => {
    if (img.width !== REQUIRED_WIDTH || img.height !== REQUIRED_HEIGHT) {
      URL.revokeObjectURL(url);
      const div = document.createElement("div");
      div.className = "error";
      div.textContent = `å°ºå¯¸éŒ¯èª¤ ${img.width}Ã—${img.height}ï¼Œæ‡‰ç‚º ${REQUIRED_WIDTH}Ã—${REQUIRED_HEIGHT} (Invalid size ${img.width}Ã—${img.height}, expected ${REQUIRED_WIDTH}Ã—${REQUIRED_HEIGHT})`;
      seriesCheck.appendChild(div);
      return;
    }

    const name = file.name.replace(/\.[^/.]+$/, "");
    let format = "INVALID";
    let g = null;
    let seriesKey = null;

    let m = name.match(formatARegex);
    if (m) { format = "A"; g = m[3].toLowerCase(); seriesKey = name.replace(/-ka-g[1-6]$/i, ""); }
    else if (formatBRegex.test(name)) { format = "B"; g = name.toLowerCase(); }

    images.push({ name, format, g, seriesKey, url });
    render();
  };

  img.src = url;
}

function render() {
  overlayArea.innerHTML = "";
  seriesCheck.innerHTML = "";

  const seriesMap = {};
  images.filter(i => i.format === "A").forEach(i => {
    if (!seriesMap[i.seriesKey]) seriesMap[i.seriesKey] = [];
    seriesMap[i.seriesKey].push(i);
  });

  Object.entries(seriesMap).forEach(([key, list]) => {
    const found = list.map(i => i.g);
    const missing = REQUIRED_G.filter(g => !found.includes(g));
    const div = document.createElement("div");
    div.innerHTML = `<b>${key}</b>ï¼š` + (missing.length ? `<span class="error">ç¼ºå°‘ ${missing.join(", ")} (lack of ${missing.join(", ")})</span>` : `<span class="ok">âœ” å®Œæ•´ (Complete)</span>`);
    seriesCheck.appendChild(div);
  });

  Object.entries(seriesMap).forEach(([key, list]) => {
    const section = document.createElement("div");
    section.className = "section";
    section.innerHTML = `<h3>${key}</h3><div class="grid-6"></div>`;
    const grid = section.querySelector(".grid-6");

    GRID_G.forEach(g => {
      const card = document.createElement("div");
      card.className = "image-card";
      card.innerHTML = `<b>${g}</b><div class="overlay-box"></div>`;
      const box = card.querySelector(".overlay-box");

      const groupImages = [];
      const b = images.find(i => i.format === "B" && i.g === g);
      if (b) groupImages.push(b.url);
      list.filter(i => i.g === g).forEach(i => groupImages.push(i.url));

      groupImages.forEach((url, idx) => {
        const img = document.createElement("img");
        img.src = url;
        img.addEventListener("click", () => openViewer(groupImages, idx));
        box.appendChild(img);
      });

      grid.appendChild(card);
    });

    overlayArea.appendChild(section);
  });

  const allG3 = images.filter(i => i.format === "A" && i.g === "g3");
  if (allG3.length) {
    const section = document.createElement("div");
    section.className = "section";
    section.innerHTML = `<h2>g3ï¼ˆæ ¼å¼ Aãƒ»å…¨ç³»åˆ—ç–Šåˆæª¢æŸ¥ï¼‰<span class="small-en">g3 (Format A Â· Full Series Overlay)</span></h2><div class="grid-6"><div class="image-card"><b>g3</b><div class="overlay-box"></div></div></div>`;
    const box = section.querySelector(".overlay-box");
    const g3Urls = allG3.map(i => i.url);
    g3Urls.forEach((url, idx) => {
      const img = document.createElement("img");
      img.src = url;
      img.addEventListener("click", () => openViewer(g3Urls, idx));
      box.appendChild(img);
    });
    overlayArea.appendChild(section);
  }
}

const viewerOverlay = document.getElementById("viewerOverlay");
const viewerContainer = document.getElementById("viewerContainer");
const viewerClose = document.getElementById("viewerClose");
const viewerScaleLabel = document.getElementById("viewerScaleLabel");
const viewerPrev = document.getElementById("viewerPrev");
const viewerNext = document.getElementById("viewerNext");

let viewerImage = null;
let scale = 0.3;
let posX = 0;
let posY = 0;
let dragging = false;
let dragStartX = 0;
let dragStartY = 0;

function openViewer(urls, startIndex = 0) {
  viewerList = urls;
  viewerIndex = startIndex;

  viewerContainer.innerHTML = "";
  viewerImage = document.createElement("img");
  viewerImage.id = "viewerImage";
  viewerContainer.appendChild(viewerImage);

  scale = 0.3;
  posX = 0;
  posY = 0;

  showViewerImage();
  viewerOverlay.style.display = "block";
}

function showViewerImage() {
  if (!viewerList.length) return;
  viewerImage.src = viewerList[viewerIndex];
  updateTransform();
}

function closeViewer() {
  viewerOverlay.style.display = "none";
  viewerContainer.innerHTML = "";
}

function updateTransform() {
  viewerImage.style.transform = `translate(-50%, -50%) translate(${posX}px, ${posY}px) scale(${scale})`;
  viewerScaleLabel.textContent = Math.round(scale * 100) + "%";
}

viewerOverlay.addEventListener("wheel", e => {
  if (!viewerImage) return;
  e.preventDefault();
  const delta = e.deltaY < 0 ? 0.1 : -0.1;
  scale = Math.min(5, Math.max(0.2, scale + delta));
  updateTransform();
}, { passive: false });

viewerContainer.addEventListener("mousedown", e => {
  dragging = true;
  dragStartX = e.clientX - posX;
  dragStartY = e.clientY - posY;
});

window.addEventListener("mousemove", e => {
  if (!dragging) return;
  posX = e.clientX - dragStartX;
  posY = e.clientY - dragStartY;
  updateTransform();
});

window.addEventListener("mouseup", () => dragging = false);

window.addEventListener("keydown", e => {
  if (viewerOverlay.style.display !== "block") return;
  if (e.key === "Escape") closeViewer();
  if (e.key === "ArrowLeft") prevImage();
  if (e.key === "ArrowRight") nextImage();
  if (e.key === "+" || e.key === "=") { scale = Math.min(5, scale + 0.1); updateTransform(); }
  if (e.key === "-") { scale = Math.max(0.2, scale - 0.1); updateTransform(); }
});

function prevImage() {
  if (!viewerList.length) return;
  viewerIndex = (viewerIndex - 1 + viewerList.length) % viewerList.length;
  showViewerImage();
}

function nextImage() {
  if (!viewerList.length) return;
  viewerIndex = (viewerIndex + 1) % viewerList.length;
  showViewerImage();
}

viewerPrev.addEventListener("click", e => { e.stopPropagation(); prevImage(); });
viewerNext.addEventListener("click", e => { e.stopPropagation(); nextImage(); });
viewerClose.addEventListener("click", closeViewer);
viewerOverlay.addEventListener("click", e => { if (e.target === viewerOverlay) closeViewer(); });

const dropZone = document.getElementById("dropZone");
dropZone.addEventListener("dragover", e => { e.preventDefault(); dropZone.classList.add("dragover"); });
dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
dropZone.addEventListener("drop", e => { e.preventDefault(); dropZone.classList.remove("dragover"); handleDrop(e); });

document.body.addEventListener("dragover", e => e.preventDefault());
document.body.addEventListener("drop", e => e.preventDefault());

const fileInput = document.getElementById("fileInput");
const folderInput = document.getElementById("folderInput");
const openFilesBtn = document.getElementById("openFilesBtn");
const openFolderBtn = document.getElementById("openFolderBtn");

openFilesBtn.addEventListener("click", () => { fileInput.value = ""; fileInput.click(); });
openFolderBtn.addEventListener("click", () => { folderInput.value = ""; folderInput.click(); });
fileInput.addEventListener("change", e => [...e.target.files].forEach(processFile));
folderInput.addEventListener("change", e => [...e.target.files].forEach(processFile));

dropZone.addEventListener("click", () => { fileInput.value = ""; fileInput.click(); });
</script>
</body>
</html>
