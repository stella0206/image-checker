<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>åœ–ç‰‡æª¢æŸ¥å·¥å…· Image Inspection Tool</title>

<style>
body { font-family: Arial, sans-serif; margin:0; padding:20px; }
h1,h2,h3 { margin-top:24px; line-height:1.25; }
.small-en { display:block; font-size:.75em; color:#555; }

#dropZone {
  border:3px dashed #444;
  padding:36px;
  text-align:center;
  font-size:18px;
  margin-bottom:16px;
  cursor:pointer;
}
#dropZone.dragover { background:#f0f0f0; }

.section { margin-bottom:48px; padding-bottom:16px; border-bottom:1px dashed #ccc; }
.grid-6 { display:grid; grid-template-columns:repeat(6,1fr); gap:16px; }

.image-card {
  border:1px solid #ddd;
  padding:8px;
  font-size:12px;
  border-radius:6px;
  background:#fafafa;
}
.image-card b { display:block; text-align:center; margin-bottom:4px; }

.overlay-box {
  position:relative;
  width:100%;
  aspect-ratio:1/1;
  border:1px solid #aaa;
  background:#fff;
}
.overlay-box img {
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:contain;
  cursor:pointer;
}

.ok{color:green;} .error{color:red;}

/* ===== Viewer ===== */
#viewerOverlay {
  position:fixed; inset:0;
  background:rgba(0,0,0,.88);
  display:none; z-index:9999;
}
#viewerContainer { position:absolute; inset:0; overflow:hidden; }
#viewerWrap {
  position:absolute;
  top:50%; left:50%;
  transform-origin:center;
}
#viewerWrap img {
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:contain;
  pointer-events:none;
}
#viewerClose {
  position:fixed; top:12px; right:16px;
  font-size:22px; color:#fff; cursor:pointer;
}
#viewerScale {
  position:fixed; top:12px; left:16px;
  color:#fff; font-size:16px;
}
#viewerInfo {
  position:fixed;
  right:16px;
  bottom:25%;
  font-size:14px;
  color:rgba(255,255,255,.8);
  text-align:right;
}
</style>
</head>

<body>

<h1>åœ–ç‰‡æª¢æŸ¥å·¥å…·<span class="small-en">Image Inspection Tool</span></h1>

<div id="dropZone">
  ğŸ‘‰ æ‹–å…¥åœ–ç‰‡æˆ–è³‡æ–™å¤¾,æˆ–é»æ­¤é¸å–
  <span class="small-en">Drag images or folders here, or click to browse</span>
</div>

<h2>ç–Šåˆæª¢æŸ¥<span class="small-en">Overlay Inspection</span></h2>
<div id="overlayArea"></div>

<div id="viewerOverlay">
  <div id="viewerContainer"></div>
  <div id="viewerClose">âœ•</div>
  <div id="viewerScale">30%</div>
  <div id="viewerInfo">
    â† / â†’:åˆ‡æ› g<br>
    æ»¾è¼ª:ç¸®æ”¾ã€€Esc:é—œé–‰
    <div class="small-en">â† / â†’: switch g Â· Wheel: zoom Â· Esc: close</div>
  </div>
</div>

<script>
const REQUIRED = 4800;
const GS = ["g1","g2","g3","g4","g5","g6"];
const formatA = /^3([MW])[A-Za-z](\d{8})-ka-(g[1-6])$/i;
const formatB = /^(g[1-6])$/i;

let images=[];
let viewerSeries=null;
let viewerGIndex=0;
let scale=0.3;

/* ===== è®€è³‡æ–™å¤¾ ===== */
function readEntry(entry){
  return new Promise(res=>{
    if(entry.isFile){
      entry.file(f=>res([f]));
    }else{
      const r=entry.createReader();
      r.readEntries(es=>{
        Promise.all(es.map(readEntry)).then(a=>res(a.flat()));
      });
    }
  });
}

/* ===== Drop ===== */
dropZone.addEventListener("dragover",e=>{
  e.preventDefault(); dropZone.classList.add("dragover");
});
dropZone.addEventListener("dragleave",()=>dropZone.classList.remove("dragover"));
dropZone.addEventListener("drop",async e=>{
  e.preventDefault(); dropZone.classList.remove("dragover");
  const items=[...e.dataTransfer.items];
  const entries=items.map(i=>i.webkitGetAsEntry()).filter(Boolean);
  if(entries.length){
    const files=(await Promise.all(entries.map(readEntry))).flat();
    files.forEach(processFile);
  }else{
    [...e.dataTransfer.files].forEach(processFile);
  }
});

/* ===== è™•ç†åœ–ç‰‡ ===== */
function processFile(file){
  if(!file.type.startsWith("image/")) return;
  const url=URL.createObjectURL(file);
  const im=new Image();
  im.onload=()=>{
    if(im.width!==REQUIRED||im.height!==REQUIRED) return;
    const name=file.name.replace(/\.[^/.]+$/,"");
    let m=name.match(formatA);
    if(m){
      images.push({
        format:"A",
        g:m[3].toLowerCase(),
        series:name.replace(/-ka-g[1-6]$/i,""),
        url
      });
    }else if(formatB.test(name)){
      images.push({ format:"B", g:name.toLowerCase(), url });
    }
    render();
  };
  im.src=url;
}

/* ===== Render ===== */
function render(){
  overlayArea.innerHTML="";
  const seriesMap={};
  images.filter(i=>i.format==="A").forEach(i=>{
    (seriesMap[i.series]??=[]).push(i);
  });

  Object.entries(seriesMap).forEach(([key,list])=>{
    const sec=document.createElement("div");
    sec.className="section";
    sec.innerHTML=`<h3>${key}</h3><div class="grid-6"></div>`;
    const grid=sec.querySelector(".grid-6");

    GS.forEach(g=>{
      const card=document.createElement("div");
      card.className="image-card";
      card.innerHTML=`<b>${g}</b><div class="overlay-box"></div>`;
      const box=card.querySelector(".overlay-box");

      const b=images.find(i=>i.format==="B"&&i.g===g);
      const a=list.find(i=>i.g===g);

      [b,a].forEach(i=>{
        if(!i) return;
        const img=document.createElement("img");
        img.src=i.url;
        img.onclick=()=>openViewer(key,g);
        box.appendChild(img);
      });

      grid.appendChild(card);
    });
    overlayArea.appendChild(sec);
  });
}

/* ===== Viewer ===== */
function openViewer(series,g){
  viewerSeries=series;
  viewerGIndex=GS.indexOf(g);
  scale=0.3;
  viewerOverlay.style.display="block";
  renderViewer();
}

function renderViewer(){
  viewerContainer.innerHTML="";
  const wrap=document.createElement("div");
  wrap.id="viewerWrap";
  wrap.style.transform=`translate(-50%,-50%) scale(${scale})`;

  const g=GS[viewerGIndex];
  const b=images.find(i=>i.format==="B"&&i.g===g);
  const a=images.find(i=>i.format==="A"&&i.series===viewerSeries&&i.g===g);

  [b,a].forEach(i=>{
    if(!i) return;
    const im=document.createElement("img");
    im.src=i.url;
    wrap.appendChild(im);
  });

  viewerContainer.appendChild(wrap);
  viewerScale.textContent=Math.round(scale*100)+"%";
}

viewerOverlay.addEventListener("wheel",e=>{
  e.preventDefault();
  scale+=e.deltaY<0?0.05:-0.05;
  scale=Math.max(.2,Math.min(5,scale));
  renderViewer();
},{passive:false});

window.addEventListener("keydown",e=>{
  if(viewerOverlay.style.display!=="block") return;
  if(e.key==="Escape") viewerOverlay.style.display="none";
  if(e.key==="ArrowRight"){viewerGIndex=(viewerGIndex+1)%6;renderViewer();}
  if(e.key==="ArrowLeft"){viewerGIndex=(viewerGIndex+5)%6;renderViewer();}
});

viewerClose.onclick=()=>viewerOverlay.style.display="none";
viewerOverlay.onclick=e=>{ if(e.target===viewerOverlay) viewerOverlay.style.display="none"; };
</script>

</body>
</html>
